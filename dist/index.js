import * as rrweb from 'rrweb';
import { record } from 'rrweb';
import 'pako';

const kIsNodeJS = Object.prototype.toString.call(typeof process !== 'undefined' ? process : 0) === '[object process]';
const kRequire = kIsNodeJS ? module.require : null; // eslint-disable-line

function createBase64WorkerFactory(base64, sourcemap = null) {
    const source = kIsNodeJS ? Buffer.from(base64, 'base64').toString('ascii') : atob(base64);
    const start = source.indexOf('\n', 10) + 1;
    const body = source.substring(start) + (sourcemap ? `//# sourceMappingURL=${sourcemap}` : '');

    if (kIsNodeJS) {
        /* node.js */
        const Worker = kRequire('worker_threads').Worker; // eslint-disable-line
        return function WorkerFactory(options) {
            return new Worker(body, Object.assign({}, options, { eval: true }));
        };
    }

    /* browser */
    const blob = new Blob([body], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    return function WorkerFactory(options) {
        return new Worker(url, options);
    };
}

/* eslint-disable */
const WorkerFactory = createBase64WorkerFactory('Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwpzZWxmLmltcG9ydFNjcmlwdHMoJ2h0dHA6Ly9sb2NhbGhvc3Q6MTAyNC9qc2Vuc2NyaXB0Lm1pbi5qcycpOwpzZWxmLmltcG9ydFNjcmlwdHMoJ2h0dHA6Ly9sb2NhbGhvc3Q6MTAyNC9jcnlwdG8uanMnKTsKCgpjb25zb2xlLmxvZygnc2VsZi5sb2NhdGlvbjonLCBzZWxmLmxvY2F0aW9uKTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uIChlKSB7CgogICAgLy8gaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGggPiAwKSB7CiAgICAvLyAgICAgZmV0Y2goJ2h0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9hZGQnLCB7CiAgICAvLyAgICAgICAgIG1ldGhvZDogJ1BPU1QnLCAvLyAqR0VULCBQT1NULCBQVVQsIERFTEVURSwgZXRjLgogICAgLy8gICAgICAgICBoZWFkZXJzOnsKICAgIC8vICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicKICAgIC8vICAgICAgICAgIH0sCiAgICAvLyAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShwYXJhbXMpCiAgICAvLyAgICAgfSkKICAgIC8vICAgICAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5qc29uKCkpCiAgICAvLyAgICAgLnRoZW4ocmVzcCA9PiB7CiAgICAvLyAgICAgICAgIGRlYnVnZ2VyOwogICAgLy8gICAgIH0pLmNhdGNoKGVyciA9PiB7CiAgICAvLyAgICAgICAgIHRoaXMuY29uc29sZS5sb2coJ2VycjonLCBlcnIpOwogICAgLy8gICAgIH0pCiAgICAvLyB9CiAgICBzZWxmLnNhdmVEYXRhVG9JbmRleGVkREIoZS5kYXRhKTsKICAgIAp9LCBmYWxzZSk7CgoKCmNvbnN0IG9yaWdpbktleSA9ICcwMzIxZWJlYmExZjc1ZGUyZDNjZDM0NzFhZjc0MThhNCc7CmNvbnN0IG9yaWdpbkl2ID0gJ0FCQ0RFRjEyMzQxMjM0MTInOwoKCnNlbGYuZW5jcnlwdERhdGEgPSBmdW5jdGlvbihkYXRhKSB7CgogICAgY29uc3QgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KGRhdGEpOwogICAgY29uc3QgcHVibGljS2V5ID0gJ01JR2ZNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0R05BRENCaVFLQmdRREdrNTMybHh3U3MzRUtHa2tNUWZQaUt5L3pnRlk5MWlIVlVEYTJuVERuamhydGpJMGI5NmV5ZnYvbHJyazdRZEhkQU5XK0lCa092ODArRUpaWEU5eVo1d0R0SU4rMmkzbUtvQU5raXFXOVV6aFBOd2VyV3VKRE1DZnd3NnZoUFFuU29jN29qYnRZRWVBdjFaQXdWSnF0S2RyaFlJZ1JDSFlyQkFRbGpna1RIUUlEQVFBQic7CiAgICBjb25zdCBwcml2YXRlS2V5ID0gJ01JSUNYUUlCQUFLQmdRREdrNTMybHh3U3MzRUtHa2tNUWZQaUt5L3pnRlk5MWlIVlVEYTJuVERuamhydGpJMGI5NmV5ZnYvbHJyazdRZEhkQU5XK0lCa092ODArRUpaWEU5eVo1d0R0SU4rMmkzbUtvQU5raXFXOVV6aFBOd2VyV3VKRE1DZnd3NnZoUFFuU29jN29qYnRZRWVBdjFaQXdWSnF0S2RyaFlJZ1JDSFlyQkFRbGpna1RIUUlEQVFBQkFvR0JBSUJtNldpTzgyY2dRc0srbG1kbnFoU2Z5bVRRb25OZnFBYnYxRUVteVgyaEJNWi84S3FaN0FUZVhBZWZnRVRSM2FyakpGTEpISXJOK1IvZHgrak1mZ0tkMm0zZ21FKytPd1M1bGN1ajZhMnlVS1F0UURyTkgvZXVTbWhzekRLMnZ5S2J5SkNjTk9TazRxbmdMQWFSc3lQTkdrZm10L2gxNklUT0VpbzZod21oQWtFQTh0VXRtUUg4MThiQmF1L1JUc1R4clVmd0s3WThqZzZUK0pNNlBLTDQrekhiTHhrekJjZ0d5dG8zYlJKNWsyMWFKelk4NUFyNHd5MkpTYUh3QmJKTnRRSkJBTkZZRytSQmwrZStQdnc5VGhveEJjTkZwamJLOWFVOFNTY1RpaXhSdGVBZ0J4YTQ1WGxTZHQ4N0Z5VlZieGtHOTRMOWNIa2hjSUdqdk8xYm5kYXIwTWtDUUdIQm5oU2RyenJ5WVlUNlBFbTRrUTVRQ29pZVdXeGF4QWpxeENRSys2NnNHRyt5ZGs3YWdwbUJGWlVNUGZNeXIzdGZvMDJ1ZVF5aHRVWDJNaGtvK1kwQ1FDd0FXQVIzSVFXdHdERm1kVmNkL0xjWm1hRWtzZE1rUTcvNTVHNENVcmNrSkRsTGJiZzlkQXpocjdEQ0wxTFVXd3ZtVjFDdWphWkNFMERVbysxdU9ia0NRUUNEZUJxeUZ6alV4N0NER2xPMklxK0tWYTI0NnJpZFY1R0p4SWRQaUF2TjZnMS8vNGhzcFNGMitkaFB1NEcwdGQxZ3FpbUxLdW9ObnVmWkUyZ2wyOE5GJzsKICAgIGNvbnN0IGVuY3J5cHRlZE1lc3NhZ2UgPSAgc2VsZi5lbmNyeXB0KG1lc3NhZ2UsIHB1YmxpY0tleSwgcHJpdmF0ZUtleSk7CiAgICB0aGlzLmNvbnNvbGUubG9nKCdlbmNyeXB0ZWRNZXNzYWdlOicsIGVuY3J5cHRlZE1lc3NhZ2UpOwogICAgY29uc3QgZGVjcnlwdGVkTWVzc2FnZSA9IHNlbGYuZGVjcnlwdChlbmNyeXB0ZWRNZXNzYWdlLCBwdWJsaWNLZXksIHByaXZhdGVLZXkpOwogICAgdGhpcy5jb25zb2xlLmxvZygnZGVjcnlwdGVkTWVzc2FnZTonLCBkZWNyeXB0ZWRNZXNzYWdlKTsKICAgIHJldHVybiBlbmNyeXB0ZWRNZXNzYWdlOwp9OwoKCnNlbGYuZW5jcnlwdCA9IGZ1bmN0aW9uKHdvcmQpIHsKICAgIGNvbnN0IGtleSA9IENyeXB0b0pTLmVuYy5IZXgucGFyc2Uob3JpZ2luS2V5KTsgIC8v5Y2B5YWt5L2N5Y2B5YWt6L+b5Yi25pWw5L2c5Li65a+G6ZKlCiAgICBjb25zdCBpdiA9IENyeXB0b0pTLmVuYy5IZXgucGFyc2Uob3JpZ2luSXYpOyAKICAgIHRoaXMuY29uc29sZS50aW1lKCdlbmNyeXB0ZWQgdGltZTonKTsKICAgIGxldCBlbmNyeXB0ZWQgPSBDcnlwdG9KUy5BRVMuZW5jcnlwdCh3b3JkLCBrZXksIHsgaXY6IGl2LCBtb2RlOiBDcnlwdG9KUy5tb2RlLkNCQywgcGFkZGluZzogQ3J5cHRvSlMucGFkLlBrY3M3IH0pOwogICAgdGhpcy5jb25zb2xlLnRpbWVFbmQoJ2VuY3J5cHRlZCB0aW1lOicpOwogICAgdmFyIHJlc3VsdCA9IENyeXB0b0pTLmVuYy5CYXNlNjQuc3RyaW5naWZ5KGVuY3J5cHRlZC5jaXBoZXJ0ZXh0KTsKICAgIHJldHVybiByZXN1bHQ7Cgp9OwoKc2VsZi5kZWNyeXB0ID0gZnVuY3Rpb24gKHdvcmQsIHB1YmxpY0tleSwgcHJpdmF0ZUtleSkgewogICAgdmFyIGVuY3J5cHRUb29sID0gbmV3IEpTRW5jcnlwdCgpOwogICAgZW5jcnlwdFRvb2wuc2V0UHVibGljS2V5KHB1YmxpY0tleSk7CiAgICBlbmNyeXB0VG9vbC5zZXRQcml2YXRlS2V5KHByaXZhdGVLZXkpOwogICAgY29uc3QgZW5jcnlwdEtleSA9IGVuY3J5cHRUb29sLmVuY3J5cHQob3JpZ2luS2V5KTsKICAgIGNvbnN0IGVuY3J5cHRJdiA9IGVuY3J5cHRUb29sLmVuY3J5cHQob3JpZ2luSXYpOwoKICAgIHRoaXMuY29uc29sZS5sb2coJ2VuY3J5cHRLZXk6JywgZW5jcnlwdEtleSk7CiAgICAKICAgIGNvbnN0IGRlY3J5cHRLZXkgPSBlbmNyeXB0VG9vbC5kZWNyeXB0KGVuY3J5cHRLZXkpOwogICAgY29uc3QgZGVjcnlwdEl2ID0gZW5jcnlwdFRvb2wuZGVjcnlwdChlbmNyeXB0SXYpOwoKCiAgICBjb25zdCBrZXkgPSBDcnlwdG9KUy5lbmMuSGV4LnBhcnNlKGRlY3J5cHRLZXkpOyAgLy/ljYHlha3kvY3ljYHlha3ov5vliLbmlbDkvZzkuLrlr4bpkqUKICAgIGNvbnN0IGl2ID0gQ3J5cHRvSlMuZW5jLkhleC5wYXJzZShkZWNyeXB0SXYpOyAKCgogICAgbGV0IGRlY3J5cHQgPSBDcnlwdG9KUy5BRVMuZGVjcnlwdCh7Y2lwaGVydGV4dDogQ3J5cHRvSlMuZW5jLkJhc2U2NC5wYXJzZSh3b3JkKX0sIGtleSwgeyBpdjogaXYsIG1vZGU6IENyeXB0b0pTLm1vZGUuQ0JDLCBwYWRkaW5nOiBDcnlwdG9KUy5wYWQuUGtjczcgfSk7CiAgICBsZXQgZGVjcnlwdGVkU3RyID0gZGVjcnlwdC50b1N0cmluZyhDcnlwdG9KUy5lbmMuVXRmOCk7CiAgICByZXR1cm4gZGVjcnlwdGVkU3RyOwp9OwoKCnNlbGYuc2F2ZURhdGFUb0luZGV4ZWREQiA9IGFzeW5jIGZ1bmN0aW9uKGRhdGEpIHsKICAgIC8vIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbGYuZmV0Y2hEcmNmcm9tSW5kZXhlZERCKCk7CiAgICAvLyBjb25zdCBwYXJhbXMgPSB7CiAgICAvLyAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkocmVzdWx0KSwKICAgIC8vIH0KICAgIGNvbnN0IHJlc3VsdCA9IHNlbGYuZW5jcnlwdERhdGEoZGF0YS5sb2dEYXRhKTsKICAgIAogICAgY29uc3QgcHVibGljS2V5ID0gJ01JR2ZNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0R05BRENCaVFLQmdRREdrNTMybHh3U3MzRUtHa2tNUWZQaUt5L3pnRlk5MWlIVlVEYTJuVERuamhydGpJMGI5NmV5ZnYvbHJyazdRZEhkQU5XK0lCa092ODArRUpaWEU5eVo1d0R0SU4rMmkzbUtvQU5raXFXOVV6aFBOd2VyV3VKRE1DZnd3NnZoUFFuU29jN29qYnRZRWVBdjFaQXdWSnF0S2RyaFlJZ1JDSFlyQkFRbGpna1RIUUlEQVFBQic7CiAgICBjb25zdCBwcml2YXRlS2V5ID0gJ01JSUNYUUlCQUFLQmdRREdrNTMybHh3U3MzRUtHa2tNUWZQaUt5L3pnRlk5MWlIVlVEYTJuVERuamhydGpJMGI5NmV5ZnYvbHJyazdRZEhkQU5XK0lCa092ODArRUpaWEU5eVo1d0R0SU4rMmkzbUtvQU5raXFXOVV6aFBOd2VyV3VKRE1DZnd3NnZoUFFuU29jN29qYnRZRWVBdjFaQXdWSnF0S2RyaFlJZ1JDSFlyQkFRbGpna1RIUUlEQVFBQkFvR0JBSUJtNldpTzgyY2dRc0srbG1kbnFoU2Z5bVRRb25OZnFBYnYxRUVteVgyaEJNWi84S3FaN0FUZVhBZWZnRVRSM2FyakpGTEpISXJOK1IvZHgrak1mZ0tkMm0zZ21FKytPd1M1bGN1ajZhMnlVS1F0UURyTkgvZXVTbWhzekRLMnZ5S2J5SkNjTk9TazRxbmdMQWFSc3lQTkdrZm10L2gxNklUT0VpbzZod21oQWtFQTh0VXRtUUg4MThiQmF1L1JUc1R4clVmd0s3WThqZzZUK0pNNlBLTDQrekhiTHhrekJjZ0d5dG8zYlJKNWsyMWFKelk4NUFyNHd5MkpTYUh3QmJKTnRRSkJBTkZZRytSQmwrZStQdnc5VGhveEJjTkZwamJLOWFVOFNTY1RpaXhSdGVBZ0J4YTQ1WGxTZHQ4N0Z5VlZieGtHOTRMOWNIa2hjSUdqdk8xYm5kYXIwTWtDUUdIQm5oU2RyenJ5WVlUNlBFbTRrUTVRQ29pZVdXeGF4QWpxeENRSys2NnNHRyt5ZGs3YWdwbUJGWlVNUGZNeXIzdGZvMDJ1ZVF5aHRVWDJNaGtvK1kwQ1FDd0FXQVIzSVFXdHdERm1kVmNkL0xjWm1hRWtzZE1rUTcvNTVHNENVcmNrSkRsTGJiZzlkQXpocjdEQ0wxTFVXd3ZtVjFDdWphWkNFMERVbysxdU9ia0NRUUNEZUJxeUZ6alV4N0NER2xPMklxK0tWYTI0NnJpZFY1R0p4SWRQaUF2TjZnMS8vNGhzcFNGMitkaFB1NEcwdGQxZ3FpbUxLdW9ObnVmWkUyZ2wyOE5GJzsKICAgIHZhciBlbmNyeXB0VG9vbCA9IG5ldyBKU0VuY3J5cHQoKTsKICAgIGVuY3J5cHRUb29sLnNldFB1YmxpY0tleShwdWJsaWNLZXkpOwogICAgZW5jcnlwdFRvb2wuc2V0UHJpdmF0ZUtleShwcml2YXRlS2V5KTsKICAgIGNvbnN0IGVuY3J5cHRLZXkgPSBlbmNyeXB0VG9vbC5lbmNyeXB0KG9yaWdpbktleSk7CiAgICBjb25zdCBlbmNyeXB0SXYgPSBlbmNyeXB0VG9vbC5lbmNyeXB0KG9yaWdpbkl2KTsKICAgIGF3YWl0IHNlbGYuaW5pdCgpOwogICAgY29uc3QgbG9nRGF0YSA9IHsKICAgICAgICBpZDogYHMxLSR7bmV3IERhdGUoKS5nZXRUaW1lKCl9YCwKICAgICAgICBzMTogZW5jcnlwdEtleSwKICAgICAgICBzMjogZW5jcnlwdEl2LAogICAgICAgIGV2ZW50OiBkYXRhLmV2ZW50LAogICAgICAgIHRpbWU6IGRhdGEuY3JlYXRlVGltZSwKICAgICAgICB1c2VySWQ6IGRhdGEudXNlcklkLAogICAgICAgIGFwcElkOiBkYXRhLmFwcElkLAogICAgfTsKICAgIAogICAgY29uc3QgcmVjb3JkcyA9IGF3YWl0IHNlbGYuZmV0Y2hEcmNmcm9tSW5kZXhlZERCKCk7CiAgICBpZihyZWNvcmRzICYmIHJlY29yZHMubGVuZ3RoID49IDUpIHsKICAgICAgICBhd2FpdCB0aGlzLnNhdmVUb0JhY2t3YXJkKHJlY29yZHMpOwogICAgICAgIHNlbGYuYWRkKGxvZ0RhdGEpOwogICAgfWVsc2UgewogICAgICAgIHNlbGYuYWRkKGxvZ0RhdGEpOwogICAgfQoKfTsKCgpzZWxmLmZldGNoRHJjZnJvbUluZGV4ZWREQiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVzamVjdCkgPT4gewogICAgICAgIGlmKCFzZWxmLmRiKSB7CiAgICAgICAgICAgIHNlbGYuaW5pdCgpLnRoZW4oYXN5bmMgKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VsZi5yZWFkKCk7CiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VsZi5yZWFkKCk7CiAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICB9CiAgICB9KQp9OwoKc2VsZi5yZWFkID0gYXN5bmMgZnVuY3Rpb24oKSB7CiAgICBsZXQgdm0gPSBzZWxmOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHRyYW5zYWN0aW9uID0gdm0uZGIudHJhbnNhY3Rpb24oWydsb2cnXSk7CiAgICAgICAgdmFyIG9iamVjdFN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoJ2xvZycsICdyZWFkJyk7CiAgICAgICAgdmFyIHJlcXVlc3QgPSBvYmplY3RTdG9yZS5vcGVuQ3Vyc29yKCk7CiAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJlamVjdCgn6K+75Y+W5LqL5Yqh5aSx6LSlJyk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfor7vlj5bkuovliqHlpLHotKUnKTsKICAgICAgICB9OwoKICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBjdXJzb3IgPSBldmVudC50YXJnZXQucmVzdWx0OwogICAgICAgICAgICBpZihjdXJzb3IpIHsKCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnbG9nSWQnLCBjdXJzb3IudmFsdWUpOwogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY3Vyc29yLnZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdsb2dEZXRhaWwnLCByZXF1ZXN0LnJlc3VsdC5sb2dEZXRhaWwpOwogICAgICAgICAgICAgICAgY3Vyc29yLmNvbnRpbnVlKCk7CiAgICAgICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KQogICAgCn07CgpzZWxmLmFkZCA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICB2YXIgYWRkUmVxdWVzdCA9IHNlbGYuZGIudHJhbnNhY3Rpb24oWydsb2cnXSwgJ3JlYWR3cml0ZScpCiAgICAgICAgICAgLm9iamVjdFN0b3JlKCdsb2cnKS5hZGQoZGF0YSk7CiAgICAgICBhZGRSZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgIGNvbnNvbGUubG9nKCfmlbDmja7lhpnlhaXmiJDlip8nKTsKICAgICAgICAgICByZXNvbHZlKCfmlbDmja7lhpnlhaXmiJDlip8nKTsKICAgICAgIH07CgogICAgICAgYWRkUmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICBjb25zb2xlLmxvZygn5pWw5o2u5YaZ5YWl5aSx6LSlJyk7CiAgICAgICAgICAgcmVqZWN0KCfmlbDmja7lhpnlhaXlpLHotKUnKTsKICAgICAgIH07CiAgICB9KTsKICAgCn07CgoKCnNlbGYuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgIHZhciByZXF1ZXN0ID0gc2VsZi5pbmRleGVkREIub3BlbignbG9nJywgMSk7CiAgICAgICByZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgIGNvbnNvbGUubG9nKCfmlbDmja7lupPmiZPlvIDlpLHotKUnKTsKICAgICAgICAgICByZWplY3QoJ+aVsOaNruW6k+aJk+W8gOWksei0pScpOwogICAgICAgfTsKICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICBzZWxmLmRiID0gcmVxdWVzdC5yZXN1bHQ7CiAgICAgICAgICAgY29uc29sZS5sb2coJ+aVsOaNruW6k+aJk+W8gOaIkOWKnycpOwogICAgICAgICAgIHJlc29sdmUoJ+aVsOaNruW6k+aJk+W8gOaIkOWKnycpOwogICAgICAgfTsKCiAgICAgICByZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgICAgIHNlbGYuZGIgPSBldmVudC50YXJnZXQucmVzdWx0OwogICAgICAgICAgIHZhciBvYmplY3RTdG9yZTsKICAgICAgICAgICBpZighc2VsZi5kYi5vYmplY3RTdG9yZU5hbWVzLmNvbnRhaW5zKCdsb2cnKSkgewogICAgICAgICAgICAgICBvYmplY3RTdG9yZSA9IHNlbGYuZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ2xvZycsIHtrZXlQYXRoOiAnaWQnfSk7CiAgICAgICAgICAgICAgIG9iamVjdFN0b3JlLmNyZWF0ZUluZGV4KCdzMScsICdzMScsIHsgdW5pcXVlOiBmYWxzZSB9KTsKICAgICAgICAgICAgICAgb2JqZWN0U3RvcmUuY3JlYXRlSW5kZXgoJ3MyJywgJ3MyJywgeyB1bmlxdWU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICBvYmplY3RTdG9yZS5jcmVhdGVJbmRleCgnZXZlbnQnLCAnZXZlbnQnLCB7IHVuaXF1ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgIG9iamVjdFN0b3JlLmNyZWF0ZUluZGV4KCd0aW1lJywgJ3RpbWUnLCB7IHVuaXF1ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgIG9iamVjdFN0b3JlLmNyZWF0ZUluZGV4KCd1c2VySWQnLCAndXNlcklkJywgeyB1bmlxdWU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICBvYmplY3RTdG9yZS5jcmVhdGVJbmRleCgnYXBwSWQnLCAnYXBwSWQnLCB7IHVuaXF1ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgIHJlc29sdmUoJ+aVsOaNruW6k+aJk+W8gOaIkOWKnycpOwogICAgICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgICAgcmVqZWN0KCfmlbDmja7lupPmiZPlvIDlpLHotKUnKTsKICAgICAgICAgICB9CiAgICAgICB9OwogICAgfSkKfTsKCgpzZWxmLnNhdmVUb0JhY2t3YXJkID0gYXN5bmMgZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgc2VsZi5pc1NhdmluZyA9IHRydWU7CiAgICAgICAgZmV0Y2goYCR7c2VsZi5sb2NhdGlvbi5vcmlnaW59L3Jyd2ViL3NhdmVFdmVudGAsIHsKICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsIC8vICpHRVQsIFBPU1QsIFBVVCwgREVMRVRFLCBldGMuCiAgICAgICAgICAgIGhlYWRlcnM6ewogICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJwogICAgICAgICAgICB9LAogICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXN1bHQpLAogICAgICAgIH0pCiAgICAgICAgLnRoZW4oYXN5bmMgKHJlc3ApID0+IHsKICAgICAgICAgICAgdGhpcy5jb25zb2xlLmxvZygnaGFzU2F2ZWREYXRhOicsIHJlc3Auc3RhdHVzLCByZXNwLmJvZHkpOwogICAgICAgICAgICBpZihyZXNwLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZWxmLnJlbW92ZVNhdmVkRGF0YUZyb21lSW5kZXhzREIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgICAgcmVqZWN0KHJlc3VsdCk7CiAgICAgICAgICAgIH0gICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHsKICAgICAgICAgICAgdGhpcy5jb25zb2xlLmxvZygnZXJyOicsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgfSkgICAgICAgCn07CgpzZWxmLnJlbW92ZVNhdmVkRGF0YUZyb21lSW5kZXhzREIgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgdmFyIG9iamVjdFN0b3JlID0gc2VsZi5kYi50cmFuc2FjdGlvbihbJ2xvZyddLCAicmVhZHdyaXRlIikub2JqZWN0U3RvcmUoJ2xvZycpOyAgIAogICAgCiAgICAgICAgY29uc3QgcmVxdWVzdCA9IG9iamVjdFN0b3JlLmNsZWFyKCk7CiAgICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICByZXNvbHZlKHtzdGF0dXM6ICdvayd9KTsKICAgICAgICB9OwoKICAgICAgICBzZWxmLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmVqZWN0KHtzdGF0dXM6ICdlcnJvcid9KTsKICAgICAgICB9OwogICAgfSk7Cn07Cgo=', null);
/* eslint-enable */

const init = function() {
    
};

class TxRRweb {

    init() {
        this.events = [];
        console.log('哈哈哈哈');
        this.worker = new WorkerFactory();
        console.log('worker:', this.worker);
        this.startRecord();
    }

    startRecord() {
        console.log('rrweb:', rrweb);
        const vm = this;
        record({
            emit(event, checkout) {
                // 用任意方式存储 event
                console.log('event:', vm.events);
                vm.events.push(event);
                console.log('isCheckout:', checkout);
                if(checkout) {
                    vm.save();
                }
            },
            checkoutEveryNms: 1000 * 30 * 1,
        });
    }

    save() {
        console.time('compressData:');
        var compressData = JSON.stringify(this.events);
        console.timeEnd('compressData:');
        console.time('compress time:');
        
       // const result = unzip(compressData);
        const logData = {id: new Date().getTime(), system: '123', logDetail: compressData, creator: '默翁', createTime: new Date().getTime()};

        this.worker.postMessage({
            secretKey: this.secretKey, 
            publicKey: this.publicKey, 
            event: compressData, 
            createTime: new Date().getTime(),
            userId: '123456',
            appId: '123456',
        });
        //indexDB.add({id: new Date().getTime(), system: '123', logDetail: compressData, creator: '默翁', createTime: formateDate(new Date(), "yyyy-MM-dd hh:mm:ss")});
        //
        var localStorage = window.localStorage;
        this.events = [];
    }
    
    
}


// export const init = function() {
//     console.log('呵呵呵')
// }

//export default { init: init }

export default TxRRweb;
export { init };
